<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Meme Generator</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:       #0f0f1a;
      --surface:  #1a1a2e;
      --surface2: #16213e;
      --accent:   #e94560;
      --text:     #e0e0e0;
      --muted:    #888;
      --border:   #2a2a4a;
      --radius:   8px;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      font-size: 14px;
      min-height: 100vh;
    }

    /* â”€â”€ HEADER â”€â”€ */
    header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    header h1 { font-size: 20px; font-weight: 700; color: var(--accent); }
    header .subtitle { color: var(--muted); font-size: 13px; }

    /* â”€â”€ LAYOUT â”€â”€ */
    .app {
      display: flex;
      height: calc(100vh - 53px);
      overflow: hidden;
    }

    /* â”€â”€ SIDEBAR â”€â”€ */
    .sidebar {
      width: 220px;
      min-width: 220px;
      background: var(--surface);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .sidebar-header {
      padding: 12px;
      border-bottom: 1px solid var(--border);
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--muted);
    }
    .upload-btn {
      margin: 10px;
      padding: 10px;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
      width: calc(100% - 20px);
      transition: opacity 0.2s;
    }
    .upload-btn:hover { opacity: 0.85; }
    .templates-label {
      padding: 4px 12px 6px;
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .template-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
      padding: 4px 10px 10px;
      overflow-y: auto;
      flex: 1;
    }
    .template-thumb {
      aspect-ratio: 1;
      border-radius: 6px;
      cursor: pointer;
      overflow: hidden;
      border: 2px solid transparent;
      transition: border-color 0.15s, transform 0.15s;
      position: relative;
    }
    .template-thumb:hover  { border-color: var(--accent); transform: scale(1.04); }
    .template-thumb.active { border-color: var(--accent); }
    .template-thumb img {
      width: 100%; height: 100%;
      object-fit: cover; display: block;
    }
    .thumb-label {
      position: absolute;
      bottom: 0; left: 0; right: 0;
      background: rgba(0,0,0,0.65);
      color: #fff;
      font-size: 9px;
      text-align: center;
      padding: 2px 4px;
      font-weight: 600;
    }

    /* â”€â”€ MAIN â”€â”€ */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-width: 0;
    }
    .canvas-area {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #0a0a14;
      overflow: hidden;
      padding: 20px;
      position: relative;
    }
    #canvas {
      max-width: 100%;
      max-height: 100%;
      border-radius: 4px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.6);
      display: none;
      touch-action: none;
    }
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 14px;
      color: var(--muted);
      text-align: center;
    }
    .empty-state .icon { font-size: 64px; opacity: 0.35; }
    .empty-state p { font-size: 15px; line-height: 1.6; }

    /* â”€â”€ CONTROLS PANEL â”€â”€ */
    .controls {
      background: var(--surface);
      border-top: 1px solid var(--border);
      padding: 12px 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      overflow-y: auto;
      max-height: 270px;
    }

    /* Label tabs row */
    .labels-row {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }
    .label-tab {
      padding: 4px 12px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 20px;
      cursor: pointer;
      font-size: 12px;
      color: var(--muted);
      transition: all 0.15s;
      white-space: nowrap;
      max-width: 120px;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .label-tab.active { background: var(--accent); border-color: var(--accent); color: #fff; }
    .label-tab:hover:not(.active) { border-color: var(--accent); color: var(--text); }
    .add-label-btn {
      padding: 4px 12px;
      background: transparent;
      border: 1px dashed var(--border);
      border-radius: 20px;
      cursor: pointer;
      font-size: 12px;
      color: var(--muted);
      transition: all 0.15s;
      white-space: nowrap;
    }
    .add-label-btn:hover { border-color: var(--accent); color: var(--accent); }

    /* Input row */
    .control-row {
      display: flex;
      align-items: flex-end;
      gap: 10px;
      flex-wrap: wrap;
    }
    .control-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
      flex: 1;
      min-width: 120px;
    }
    .control-group > label {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.4px;
    }
    .text-input {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 7px 10px;
      color: var(--text);
      font-size: 14px;
      width: 100%;
      outline: none;
      transition: border-color 0.15s;
    }
    .text-input:focus { border-color: var(--accent); }
    textarea.text-input { resize: none; min-height: 66px; line-height: 1.5; }

    /* Font size */
    .range-row { display: flex; align-items: center; gap: 8px; }
    input[type=range] { flex: 1; accent-color: var(--accent); }
    .range-val { font-size: 12px; color: var(--muted); width: 30px; text-align: right; flex-shrink: 0; }

    /* Alignment */
    .align-btns { display: flex; gap: 4px; }
    .align-btn {
      width: 32px; height: 32px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 6px;
      cursor: pointer;
      color: var(--muted);
      display: flex; align-items: center; justify-content: center;
      font-size: 15px;
      transition: all 0.15s;
    }
    .align-btn.active, .align-btn:hover { background: var(--accent); border-color: var(--accent); color: #fff; }

    /* Bottom row */
    .bottom-row {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .delete-btn {
      padding: 8px 14px;
      background: transparent;
      border: 1px solid #c0392b;
      border-radius: var(--radius);
      color: #c0392b;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.15s;
      white-space: nowrap;
    }
    .delete-btn:hover { background: #c0392b; color: #fff; }
    .delete-btn:disabled { opacity: 0.35; pointer-events: none; }
    .drag-hint {
      flex: 1;
      font-size: 11px;
      color: var(--muted);
      text-align: center;
      opacity: 0.7;
    }
    .download-btn {
      padding: 8px 22px;
      background: var(--accent);
      border: none;
      border-radius: var(--radius);
      color: #fff;
      cursor: pointer;
      font-size: 14px;
      font-weight: 700;
      transition: opacity 0.15s;
      white-space: nowrap;
    }
    .download-btn:hover { opacity: 0.85; }

    /* â”€â”€ RESPONSIVE â”€â”€ */
    @media (max-width: 640px) {
      header .subtitle { display: none; }
      .app { flex-direction: column; height: auto; overflow: auto; }
      .sidebar {
        width: 100%; min-width: 0;
        height: auto;
        border-right: none;
        border-bottom: 1px solid var(--border);
      }
      .template-grid {
        grid-template-columns: repeat(5, 1fr);
        max-height: 110px;
      }
      .main { height: auto; }
      .canvas-area { min-height: 55vw; padding: 12px; }
      .controls { max-height: none; }
      .drag-hint { display: none; }
    }
  </style>
</head>
<body>

<header>
  <h1>ğŸ­ Meme Generator</h1>
  <span class="subtitle">Pick a template or upload an image â€” add text, drag to position, download</span>
</header>

<div class="app">

  <!-- â”€â”€ SIDEBAR â”€â”€ -->
  <aside class="sidebar">
    <div class="sidebar-header">Templates</div>
    <button class="upload-btn" onclick="document.getElementById('fileInput').click()">â¬† Upload Image</button>
    <input type="file" id="fileInput" accept="image/*" style="display:none">
    <div class="templates-label">Classic Memes</div>
    <div class="template-grid" id="templateGrid"></div>
  </aside>

  <!-- â”€â”€ MAIN â”€â”€ -->
  <main class="main">
    <div class="canvas-area" id="canvasArea">
      <canvas id="canvas" width="800" height="600"></canvas>
      <div class="empty-state" id="emptyState">
        <div class="icon">ğŸ–¼ï¸</div>
        <p>Select a template from the left<br>or upload your own image</p>
      </div>
    </div>

    <div class="controls">
      <!-- Label tabs -->
      <div class="labels-row" id="labelsRow"></div>

      <!-- Text + Alignment -->
      <div class="control-row">
        <div class="control-group" style="flex:2; min-width:180px;">
          <label>Text</label>
          <textarea class="text-input" id="textInput"
                    placeholder="Enter meme textâ€¦" oninput="onTextInput()"></textarea>
        </div>
        <div class="control-group" style="min-width:110px; flex:0;">
          <label>Align</label>
          <div class="align-btns">
            <button class="align-btn" id="alignLeft"   onclick="setAlign('left')"   title="Left">&#8592;</button>
            <button class="align-btn active" id="alignCenter" onclick="setAlign('center')" title="Center">&#8596;</button>
            <button class="align-btn" id="alignRight"  onclick="setAlign('right')"  title="Right">&#8594;</button>
          </div>
        </div>
      </div>

      <!-- Font size -->
      <div class="control-group">
        <label>Font Size</label>
        <div class="range-row">
          <input type="range" id="fontSizeSlider" min="12" max="120" value="48" oninput="onFontSize()">
          <span class="range-val" id="fontSizeVal">48px</span>
        </div>
      </div>

      <!-- Bottom row -->
      <div class="bottom-row">
        <button class="delete-btn" id="deleteBtn" onclick="deleteActiveLabel()">âœ• Delete Label</button>
        <span class="drag-hint">Drag text on the canvas to reposition</span>
        <button class="download-btn" onclick="downloadMeme()">â¬‡ Download Meme</button>
      </div>
    </div>
  </main>

</div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  TEMPLATES
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TEMPLATES = [
  { name: 'Drake',            img: 'templates/drake.jpg' },
  { name: 'Distracted BF',   img: 'templates/distracted-bf.jpg' },
  { name: 'Two Buttons',     img: 'templates/two-buttons.jpg' },
  { name: 'Expanding Brain', img: 'templates/expanding-brain.jpg' },
  { name: 'This Is Fine',    img: 'templates/this-is-fine.jpg' },
  { name: 'Change My Mind',  img: 'templates/change-my-mind.jpg' },
  { name: 'Surprised Pikachu', img: 'templates/surprised-pikachu.jpg' },
  { name: 'One Does Not',    img: 'templates/one-does-not.jpg' },
  { name: 'Success Kid',     img: 'templates/success-kid.jpg' },
  { name: 'Woman Yelling',   img: 'templates/woman-yelling-cat.jpg' },
  { name: 'Hide Pain Harold',img: 'templates/hide-pain-harold.jpg' },
];

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  STATE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MAX_CANVAS_W = 800;

let currentImage   = null;
let labels         = [];
let nextLabelId    = 0;
let activeLabelId  = null;
let dragging       = null; // { labelId, offsetX, offsetY }

const canvas       = document.getElementById('canvas');
const ctx          = canvas.getContext('2d');
const emptyState   = document.getElementById('emptyState');

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  INIT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function init() {
  buildTemplateGrid();
  // Default two labels
  addLabel('TOP TEXT',    0.5, 0.08);
  addLabel('BOTTOM TEXT', 0.5, 0.92);
  setActiveLabelId(labels[0].id);
  renderLabelsPanel();
  syncControls();

  // Mouse events
  canvas.addEventListener('mousedown',  onPointerDown);
  canvas.addEventListener('mousemove',  onPointerMove);
  canvas.addEventListener('mouseup',    onPointerUp);
  canvas.addEventListener('mouseleave', onPointerUp);

  // Touch events
  canvas.addEventListener('touchstart', onTouchStart, { passive: false });
  canvas.addEventListener('touchmove',  onTouchMove,  { passive: false });
  canvas.addEventListener('touchend',   onTouchEnd);

  // File upload
  document.getElementById('fileInput').addEventListener('change', onFileChange);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  TEMPLATE GRID
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildTemplateGrid() {
  const grid = document.getElementById('templateGrid');
  TEMPLATES.forEach((t, i) => {
    const wrap = document.createElement('div');
    wrap.className = 'template-thumb';
    wrap.title = t.name;

    const img = document.createElement('img');
    img.src = t.img;
    img.alt = t.name;

    const lbl = document.createElement('div');
    lbl.className = 'thumb-label';
    lbl.textContent = t.name;

    wrap.appendChild(img);
    wrap.appendChild(lbl);
    wrap.addEventListener('click', () => selectTemplate(i));
    grid.appendChild(wrap);
  });
}

function selectTemplate(index) {
  document.querySelectorAll('.template-thumb').forEach((el, i) => {
    el.classList.toggle('active', i === index);
  });

  const img = new Image();
  img.onload = () => {
    currentImage = img;
    resizeCanvas(img.naturalWidth || img.width, img.naturalHeight || img.height);
    resetLabelPositions();
    showCanvas();
    draw();
  };
  img.src = TEMPLATES[index].img;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  FILE UPLOAD
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onFileChange(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    const img = new Image();
    img.onload = () => {
      currentImage = img;
      resizeCanvas(img.naturalWidth, img.naturalHeight);
      resetLabelPositions();
      showCanvas();
      draw();
      document.querySelectorAll('.template-thumb').forEach(el => el.classList.remove('active'));
    };
    img.src = ev.target.result;
  };
  reader.readAsDataURL(file);
  e.target.value = '';
}

function showCanvas() {
  emptyState.style.display = 'none';
  canvas.style.display = 'block';
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  CANVAS SIZING
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function resizeCanvas(w, h) {
  const scale  = Math.min(1, MAX_CANVAS_W / w);
  canvas.width  = Math.round(w * scale);
  canvas.height = Math.round(h * scale);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  LABELS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addLabel(text, relX, relY) {
  const label = {
    id:       nextLabelId++,
    text:     text ?? 'TEXT',
    x:        canvas.width  * (relX ?? 0.5),
    y:        canvas.height * (relY ?? 0.5),
    fontSize: 48,
    align:    'center'
  };
  labels.push(label);
  return label;
}

function addLabelFromButton() {
  const label = addLabel('NEW TEXT', 0.5, 0.5);
  renderLabelsPanel();
  setActiveLabelId(label.id);
  syncControls();
  draw();
}

function deleteActiveLabel() {
  if (labels.length <= 1) return;
  labels = labels.filter(l => l.id !== activeLabelId);
  const next = labels[labels.length - 1];
  setActiveLabelId(next?.id ?? null);
  renderLabelsPanel();
  syncControls();
  draw();
}

function resetLabelPositions() {
  if (labels[0]) { labels[0].x = canvas.width * 0.5; labels[0].y = canvas.height * 0.08; }
  if (labels[1]) { labels[1].x = canvas.width * 0.5; labels[1].y = canvas.height * 0.92; }
  for (let i = 2; i < labels.length; i++) {
    labels[i].x = canvas.width * 0.5;
    labels[i].y = canvas.height * 0.5;
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  LABELS PANEL
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderLabelsPanel() {
  const row = document.getElementById('labelsRow');
  row.innerHTML = '';

  labels.forEach(l => {
    const btn = document.createElement('button');
    btn.className = 'label-tab' + (l.id === activeLabelId ? ' active' : '');
    const preview = l.text ? (l.text.length > 12 ? l.text.slice(0, 12) + 'â€¦' : l.text) : '(empty)';
    btn.textContent = preview;
    btn.addEventListener('click', () => {
      setActiveLabelId(l.id);
      renderLabelsPanel();
      syncControls();
    });
    row.appendChild(btn);
  });

  const addBtn = document.createElement('button');
  addBtn.className = 'add-label-btn';
  addBtn.textContent = '+ Add Text';
  addBtn.addEventListener('click', addLabelFromButton);
  row.appendChild(addBtn);

  // Delete button state
  document.getElementById('deleteBtn').disabled = labels.length <= 1;
}

function setActiveLabelId(id) {
  activeLabelId = id;
}

function getActiveLabel() {
  return labels.find(l => l.id === activeLabelId) ?? null;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  CONTROLS SYNC
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function syncControls() {
  const label = getActiveLabel();
  if (!label) return;
  document.getElementById('textInput').value        = label.text;
  document.getElementById('fontSizeSlider').value   = label.fontSize;
  document.getElementById('fontSizeVal').textContent = label.fontSize + 'px';
  ['left', 'center', 'right'].forEach(a => {
    document.getElementById('align' + cap(a)).classList.toggle('active', label.align === a);
  });
}

function onTextInput() {
  const label = getActiveLabel();
  if (!label) return;
  label.text = document.getElementById('textInput').value;
  renderLabelsPanel();
  setActiveLabelId(label.id);
  draw();
}

function onFontSize() {
  const label = getActiveLabel();
  if (!label) return;
  label.fontSize = parseInt(document.getElementById('fontSizeSlider').value);
  document.getElementById('fontSizeVal').textContent = label.fontSize + 'px';
  draw();
}

function setAlign(align) {
  const label = getActiveLabel();
  if (!label) return;
  label.align = align;
  ['left', 'center', 'right'].forEach(a => {
    document.getElementById('align' + cap(a)).classList.toggle('active', a === align);
  });
  draw();
}

function cap(s) { return s.charAt(0).toUpperCase() + s.slice(1); }

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  DRAW
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  if (currentImage) {
    ctx.drawImage(currentImage, 0, 0, canvas.width, canvas.height);
  } else {
    ctx.fillStyle = '#111';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
  }

  labels.forEach(drawLabel);
}

function drawLabel(label) {
  if (!label.text) return;
  const fs         = label.fontSize;
  const lineHeight = fs * 1.25;
  const lines      = label.text.split('\n');
  const totalH     = lines.length * lineHeight;

  ctx.save();
  ctx.font         = `bold ${fs}px Impact, "Arial Black", sans-serif`;
  ctx.textAlign    = label.align;
  ctx.textBaseline = 'middle';

  const lw = Math.max(1, fs / 7);
  ctx.lineWidth  = lw * 2;
  ctx.lineJoin   = 'round';

  lines.forEach((line, i) => {
    const y = label.y - totalH / 2 + i * lineHeight + lineHeight / 2;
    ctx.strokeStyle = 'black';
    ctx.strokeText(line, label.x, y);
    ctx.fillStyle = 'white';
    ctx.fillText(line, label.x, y);
  });

  ctx.restore();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  HIT TEST
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function hitTest(label, px, py) {
  if (!label.text) return false;
  ctx.font = `bold ${label.fontSize}px Impact, "Arial Black", sans-serif`;
  const lines      = label.text.split('\n');
  const lineHeight = label.fontSize * 1.25;
  const totalH     = lines.length * lineHeight;
  const w          = Math.max(...lines.map(l => ctx.measureText(l).width));
  const pad = 10;
  let x0;
  if      (label.align === 'center') x0 = label.x - w / 2;
  else if (label.align === 'right')  x0 = label.x - w;
  else                               x0 = label.x;
  const y0 = label.y - totalH / 2;
  return px >= x0 - pad && px <= x0 + w + pad && py >= y0 - pad && py <= y0 + totalH + pad;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  COORDINATE MAPPING
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function canvasPos(clientX, clientY) {
  const r = canvas.getBoundingClientRect();
  return {
    x: (clientX - r.left)  * (canvas.width  / r.width),
    y: (clientY - r.top)   * (canvas.height / r.height)
  };
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  MOUSE DRAG
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onPointerDown(e) {
  const pos = canvasPos(e.clientX, e.clientY);
  for (let i = labels.length - 1; i >= 0; i--) {
    if (hitTest(labels[i], pos.x, pos.y)) {
      dragging = { labelId: labels[i].id, ox: pos.x - labels[i].x, oy: pos.y - labels[i].y };
      setActiveLabelId(labels[i].id);
      renderLabelsPanel();
      syncControls();
      canvas.style.cursor = 'grabbing';
      return;
    }
  }
}

function onPointerMove(e) {
  const pos = canvasPos(e.clientX, e.clientY);
  if (dragging) {
    const lbl = labels.find(l => l.id === dragging.labelId);
    if (lbl) { lbl.x = pos.x - dragging.ox; lbl.y = pos.y - dragging.oy; draw(); }
  } else {
    canvas.style.cursor = labels.some(l => hitTest(l, pos.x, pos.y)) ? 'grab' : 'default';
  }
}

function onPointerUp() {
  dragging = null;
  canvas.style.cursor = 'default';
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  TOUCH DRAG
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onTouchStart(e) {
  e.preventDefault();
  const pos = canvasPos(e.touches[0].clientX, e.touches[0].clientY);
  for (let i = labels.length - 1; i >= 0; i--) {
    if (hitTest(labels[i], pos.x, pos.y)) {
      dragging = { labelId: labels[i].id, ox: pos.x - labels[i].x, oy: pos.y - labels[i].y };
      setActiveLabelId(labels[i].id);
      renderLabelsPanel();
      syncControls();
      return;
    }
  }
}

function onTouchMove(e) {
  e.preventDefault();
  if (!dragging) return;
  const pos = canvasPos(e.touches[0].clientX, e.touches[0].clientY);
  const lbl = labels.find(l => l.id === dragging.labelId);
  if (lbl) { lbl.x = pos.x - dragging.ox; lbl.y = pos.y - dragging.oy; draw(); }
}

function onTouchEnd() { dragging = null; }

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  DOWNLOAD
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function downloadMeme() {
  if (!currentImage) {
    alert('Please select a template or upload an image first!');
    return;
  }
  const a = document.createElement('a');
  a.download = 'meme.png';
  a.href = canvas.toDataURL('image/png');
  a.click();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  GO
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
init();
</script>
</body>
</html>
